import { beforeAll, expect, test } from "vitest";
import { RustModule } from "@repo/ledger-utils";
import { ADA, Address, Bytes, NetworkEnvironment, TxOut, Utxo, Value } from "@repo/ledger-core";
import { TxBuilder, CoinSelectionAlgorithm, EmulatorProvider } from "../src";

beforeAll(async () => {
  await RustModule.load();
});

test("validate max tx size", async () => {
  const networkEnv = NetworkEnvironment.TESTNET_PREPROD;

  const changeAddress = Address.fromBech32(
    "addr_test1qqa0q2e9aprx5xyzr6jj2hpz0g6jtjsjtve8sqxa3ynx53c99jf6vtuuzs9tfsw2ulpu6jy0u3whla495t0lje9a4fnsl4ggk3",
  );
  const feeUtxo: Utxo = {
    input: {
      txId: Bytes.fromHex("00".repeat(32)),
      index: 0,
    },
    output: new TxOut(changeAddress, new Value().add(ADA, 100_000_000n)),
  };
  const scriptUtxo = Utxo.fromHex(
    "82825820451c973119985527a81afb35cd4dcb799a9e3be74c30b3e63d552c01c9469d0a00a3005839007290b6e451c55ec417ccf332119a8b735cb44f3dc7dac405b9101cf2bf5b5bced089f4c15e6d937a2bb441ee6988fdef1eedac40f9caded5011a025e28d603d81859231882025923135923100100003323232323232323222253232323232323232323233300e3001300f3754016264a66601e646464a666024600a60266ea80044c8c8c8c8c8c8c8c8c8c8c8c8c94c8c8ccc084c0500384c8c8c8c8c8c8c8c8c8c8c94ccc0b0c07cc0b4dd50008a99981619991919191919191919191119191919191919299981f981a18201baa00313253330403034304137540062a666080606660826ea80044c8c8c8c8c8c8c8c8c8c8c8c8c8c8c8c8c8c8c8c8c8c94ccc164c1700084c8c8c8c8c8c8c94ccc174cdd780f982b998309ba904b4bd700a99982e99baf374c0466e9800454ccc174cdd79ba6026374c66607e0969110369646f004800854ccc174cdc780e191919b8a00137306e64cc0b0c190c194009220100375c60c660c06ea8c18c004c17cdd501e0a99982e99982e99baf0144c106d8799f4040ff004a094454ccc174ccc174cdd780a0082504a22a6660ba60b00242a6660ba60b001c2a6660ba607c0182a6660ba66e200d006854ccc174cdc400d00c0a99982e99b89337020300349040507b53898a99982e99b8801800a1533305d3371266e040280612080d098f7011533305d3370e004904044bd099b893028008480505280a5014a029405280a5014a029405280a5014a029405280a5014a06666088666608866607c91100488100483027eac0cdd718308011bae3061306200201104a48810369646f0048008c8ccc00400401d20002225333061002100113330030033064002337006eb4c0bcc180dd51831801000982e1baa0113303f0042303d001303f00b303e00e303a00f16375860b400260b40046eb4c160004c160008dd6982b000982b0011bad3054001305400230520013052002375a60a000260a0004609c002609c004609800260980046eb4c128004c128008dd6982400098240011bae3046001304237540022c2c608860826ea800c58c10cc100dd5182180318211821801182080098208011bab303f001303f001303a3754004600200244a666072002290000980b19801001181e0009800800911299999981e00109919191919191980680100099b8a48810128000025333039337100069007099b80483c80400c54ccc0e4cdc4001a410004266e00cdc0241002800690068b299981d800899b8a4881035b5d2900004133714911035b5f2000375c607a607c66600e00266078980102415d003303c375266e2922010129000044bd70111981f26103422c20003303e375266601001000466e28dd718050009bae300b0014bd701bac3039002375a606e0026466ec0dd4181b8009ba730380013754004264a666072002266e292201027b7d00002133714911037b5f2000375c6076607864646600200200644a6660780022006266446607e98103422c20003303f3752666012012607800466e292201023a2000333009009303d002337146eb8c02c004dd71806000a5eb80c0f8004cc008008c0fc004cc0e93010342207d003303a375200497ae03756004264a666072002266e29221025b5d00002133714911035b5f2000375c6076607866600a00266074980102415d003303a375200497ae0223303c4c0103422c20003303c375266600c00c00466e28dd718040009bae30090014bd701bac002133007375a0040022646466e292210268270000132333001001337006e3400920013371491101270000322253330393371000490000800899191919980300319b8000548004cdc599b80002533303c33710004900a0a40c02903719b8b33700002a66607866e2000520141481805206e0043370c004901019b8300148080cdc70020011bae00222232330010010042253330390011004133003303b00133002002303c00123036001230353036001223233001001003225333032302500113371491101300000315333032337100029000099b8a489012d003300200233702900000089980299b8400148050cdc599b803370a002900a240c00066002002444a66605e66e2400920001001133300300333708004900a19b8b3370066e14009201448180004c0c4c0b8dd5000980b803099980c0010020048a501632533302f00114c103d87a8000130243303030310014bd701bac3030007302f302c375405264a666054603c60566ea80044dd6981798161baa00116302e302b3754605c605e60566ea8c0b8008dd6181698170009816981698168011bab302b001302b302b001302a302a0023758605000260486ea8048c098c08cdd500f899192999811980b80809919191919192999816181780109919192999816180f98169baa001132533302d302133300b00301b4890369646f001533302d3375e002604e6606298103d87a80004bd70099baf374c60300106e98ccc03c06d2210369646f00480045280a503031302e37540022c64646600200200e44a666062002298103d87a8000132323253330313375e00c6064006260526606a00297ae013300500500230320023035002303300130253302f30300024bd701bab302f3030302c3754605e606000260566ea800458c0b4004cc018dd61816002119baf302d302a3754605a60546ea8c0b4c0b8c0a8dd50009811198161ba90164bd701bab302b302c302c302c302c302c002375660540026054605460546054002604a6ea804c54ccc08cc0600404c8c8c8c8c8c8c8c8c8c8c8c8c8c8c94ccc0c8c09cc0ccdd5000899191919299981b199911299981c9816181d1baa007132323232323232323232323232323232323232323232323232325333053304830543754006264a6660a8609060aa6ea800c4c8c8c8c8c94ccc164cdd780398299982e9ba90474bd700a99982c99baf006027153330593375e6e9802cdd30008a99982c99b8801d023153330593371004402c266e1cccc0dc08411d22010769646f706f73740000214a029405280a5014a06666080666608005002602466e052000375a60ba00602001e6eb4c174008dd6982e182e800982e00099199999800800806005a40009000240004444446464646464646464a6660c660b060c86ea80044c8c8c8c8c8c8c8c94ccc1acc180c1b0dd50010992999836183018369baa0021323232323232533307230663073375401e26464646464646464a6660fa610002004264a6660f660e060f86ea80404c8c8c8c94ccc20804c214040084c94ccc200054ccc20004cdc78068230a9998400099baf01b02115333080013375e0080162a6661000266e1c00801c54ccc20004c1d0ccc1780641b922010769646f706f73740015333080013370e02666e0ccdc100882081f0a99984000983080a0a999840009830809098308088a5014a029405280a5014a029405280a99984180812899842009ba80103308401375001e66108026ea00992f5c0266666605605604a04602001e60c004c2c60c60062c6eb4c20c04004c20c04008c20404004c1f4dd50080b182f0028b1bad307e001307e002375a60f800260f800460f400260f40046eb8c1e0004c1d0dd50078b19b800180023370003000666e0400c0054ccc1b94ccc1b8c19c0984c19c094528099b80306a33304c007026025482fe10f44ccc13001c098094ccc12c0180a009d4ccc1b14ccc1b0c1940904c19408c528099b81306833304a00b024023337049060421ea400826660940160480462c60e060da6ea800858c1bcc1c0008c1b8004c1b8008dd598360009836001183500098331baa0083068306537540022c60ce60d00046eacc198004c198008c190004c180dd51831983218301baa30630083063006306100530610053021001163058305537540062c60ae60a86ea8c15c018c158c15c008c154004c154008dd59829800982980098271baa305102630510253302902623232533304d3375e60a4609e6ea8c148c13cdd5182918298011823998289ba903b4bd70099982699baf00101f4a0944528182880098269baa001375c609c609e0046eb8c134004c124dd518260039bae304b304c002375c6094002608c6ea8c12401cdd69824182498248011bad304700130470013046002375a60880026088002608660860046eb4c104004c104c104008dd7181f800981d9baa00716375a60760026eb4c0ecc0f0004c0840384ccc08802802c048528191919299981c1816181c9baa00113232533303a302e303b375400226607c6ea0008cc0f8c0fcc0f0dd5000a5eb8058c0f8c0ecdd50019bad303d303a37540022c607860726ea8c0f0008c0ecc0f0004c0dcdd50059800801119299981a98140008991919191919191919191919191919191919191919192999827182880109919191924c66068008460640026068016606601c605e01e2c6eb0c13c004c13c008dd6982680098268011bad304b001304b002375a60920026092004608e002608e0046eb4c114004c114008c10c004c10c008c104004c104008dd6981f800981f8011bad303d001303d002375c6076002606e6ea800854ccc0d4c0a40044c8c8c8c8c8c8c8c94ccc100c10c0084c926302100516375a608200260820046eb4c0fc004c0fc008c0f4004c0f4008dd7181d800981b9baa00215333035302a001132323232533303c303f002132498c07400c58dd6981e800981e801181d800981b9baa0021630353754002606e60686ea800458c0d8c0dc008dd5981a800981a98189baa303430350023033001302f37546464a666064606a00420022c60660026601866018012466ebcc0ccc0c0dd5181998181baa30333034303037540026050660646ea40712f5c0460446660186eacc0ccc0d0c0c0dd51819981a18181baa00101c48810369646f003031302e37540566eb0c0c0c0c4008c0bc004c0bcc0bcc0bc008dd59816800981698168011bac302b001302b302b00237586052002604a6ea804c54ccc08cc0640404c8c8c8c8c8c94ccc0a4cdc4000a40002a66605266ebcdd30011ba633300b01748810769646f706f73740000113233330010013300900623375e6060605a6ea8c0c0c0b4dd51818181898169baa00130253302f375203297ae00040022222533302d302000113375e6e9c00d300101800013232323232325333033302830343754002264a66606860506660240060449110769646f706f7374001325333035302a30363754004264646464a666078607e0042646464a66607866ebcc10400801854ccc0f0cdd79ba6001374c0102666602602601e01a603802029405281bab30403041001303c3754018603a0062c6eb4c0f4004c0f4008c0ec004c0dcdd50010b191998008009919800800999980f002a4500488100482fe10f4894ccc0e800452f5c0264666444646600200200644a6660800022006264660846e9ccc108dd480319821181f800998211820000a5eb80cc00c00cc110008c108004dd7181c8009bab303a00133003003303e002303c0014bd6f7b630111299981d00108008999801801981e8011919191919299981e19b8f00402a100613333024006004002001375a608060820046eb8c0fc004c0fc008dd7181e8009bac303c002163038303537540022c606e60700046eacc0d8004c0d8c0c8dd5181a981b18191baa303500630350043033003303300316163330060010164890769646f706f737400301237566058605a605a0046eb0c0ac004c0acc0ac008dd6181480098129baa01314a044464a66604c6034604e6ea8004520001375a605660506ea8004c94ccc098c068c09cdd50008a60103d87a8000132330010013756605860526ea8008894ccc0ac004530103d87a8000132323232533302c337220100042a66605866e3c0200084c090cc0c0dd4000a5eb80530103d87a8000133006006003375a605a0066eb8c0ac008c0bc008c0b4004c8cc004004010894ccc0a80045300103d87a8000132323232533302b337220100042a66605666e3c0200084c08ccc0bcdd3000a5eb80530103d87a8000133006006003375660580066eb8c0a8008c0b8008c0b000488c8cc00400400c894ccc0a000452f5c026464a66604e600a00426605600466008008002266008008002605800460540026e012002371290001112999810980a0008a5eb7bdb1804c8c8cc0040052f5bded8c044a66604e00226605066ec0dd48031ba60034bd6f7b630099191919299981419b9000a00213302c337606ea4028dd30038028a99981419b8f00a00213302c337606ea4028dd300380189981619bb037520046e98004cc01801800cdd598148019bae3027002302b002302900132330010014bd6f7b63011299981300089981399bb037520086ea000d2f5bded8c0264646464a66604e66e400200084cc0accdd81ba9008375000e00a2a66604e66e3c0200084cc0accdd81ba9008375000e00626605666ec0dd48011ba800133006006003375a60500066eb8c098008c0a8008c0a000494ccc078c044c07cdd50008991919192999812981400109924c600c0062c6eb4c098004c098008c090004c080dd50008b1299980e9808180f1baa0011323232325333024302700213232498c94ccc08cc0580044c8c94ccc0a0c0ac0084c926325333026301900113232533302b302e002132498c03400458c0b0004c0a0dd50010a999813180d0008991919191919299981798190010a4c2c6eb4c0c0004c0c0008dd6981700098170011bad302c001302837540042c604c6ea800458c0a4004c094dd50018a999811980b8008a99981318129baa00314985858c08cdd500118030018b181280098128011811800980f9baa00116232533301d30100011323253330223025002149858dd71811800980f9baa0021533301d30110011323253330223025002149858dd71811800980f9baa00216301d375400244646600200200644a666042002293099198018019812801180198118009299980d1806980d9baa00113232323253330213024002149858dd7181100098110011bae3020001301c37540022c4444a666038601e0022008264646600200200c44a66604400226604666ec0dd48031ba60034bd6f7b630099191919299981199b9000a002133027337606ea4028dd30038028a99981199b8f00a002132533302430173025375400226605066ec0dd4805981498131baa0010041004325333024533302700114a22940530103d87a80001301c33028374c00297ae03233001001002225333028001133029337606ea402cdd400525eb7bdb1804c8c8c8c94ccc0a4cdc800780109981699bb0375201e6ea003801454ccc0a4cdc78078010992999815180e98159baa00113302e337606ea4040c0bcc0b0dd50008020802192999815180e8008a6103d87a8000130223302e375000297ae03370000201c26605a66ec0dd48011ba800133006006003375a60540066eb8c0a0008c0b0008c0a80044cc09ccdd81ba9002374c0026600c00c0066eacc09000cdd7181100118130011812000991900118030009981019bb037520046ea00052f5bded8c0600200244a666036002293099299980e0008a4c26464a66603666e40dd7180e18100021bae301c0021330050053301f002001163020002301e001301e0012323300100100222533301b00114bd6f7b630099191919299980e19b914881000021533301c301500210031005133020337606ea4008dd3000998030030019bab301d003375c6036004603e004603a002444a66602e601460306ea800c4c8c8cc004004010894ccc074004528099299980d99b8f375c604000400829444cc00c00c004c080004dd7180e180c9baa0031323300100100222533301c00114a0264a66603466ebcc07cc070dd5180f980e1baa301f3020301c3754603e00400c29444cc00c00c004c07c004c050dd50089bae3017301437540022c602c602e004602a00260226ea80305261365632533300f300200113232533301430170021324994ccc044c010c048dd5000899191919299980c180d80109924ca66602a6010602c6ea800c4c8c94ccc068c07400852616375c6036002602e6ea800c5858dd6980c800980c801180b80098099baa001161630150013011375401a2a66601e60060022a66602460226ea8034526161533300f3004001153330123011375401a2930b0a99980798030008a99980918089baa00d14985854ccc03cc01400454ccc048c044dd50068a4c2c2c601e6ea80304cc8c8c8c8c8c88c894ccc05cc8c8c94ccc068c038c06cdd50008991919191919191919192999812180b98129baa00113232325333027301b30283754002264646464646464a66605c604a0062a66605c604266600201200e9110369646f001533302e3022302f3754058264646464a66606466600c606e60686ea8c0dc01004005c54ccc0c8cdc48040010a511337120020122940dd6981b181b8011bad303500130350013034303037540582c2c264a66605e60460082a66605e604460606ea80b44c8c94ccc0c54ccc0c4c094ccc01003002922010369646f00153330313375e6e98c00c048dd32999818981224002297adef6c6013232330010014bd6f7b63011299981b80089981c19bb0375201a6e9800d2f5bded8c0264646464a66607066e400440084cc0f0cdd81ba9011374c00e00a2a66607066e3c0440084cc0f0cdd81ba9011374c00e00626607866ec0dd48011ba600133006006003375660720066eb8c0dc008c0ec008c0e4004c8cc0040052f5bded8c044a66606c00226606e66ec13001044369646f004c010120004bd6f7b630099191919299981b99b904890369646f0000213303b337609801044369646f004c01012000005153330373371e91010369646f0000213303b337609801044369646f004c0101200000313303b337606ea4008dd4000998030030019bad3038003375c606c004607400460700022a666062a66606266600a00201e02c266e2001c0085280a5113371200401029405280a999818981218191baa02f13232323232323232323232323332223233300100100400322232323232323232533304a533304a3375e609e00c609e008266e1c0080045280a9998268038a51133300a00a007005163370666e08dd6982718278028052410112f4a666090a666090608201e2608201c29404c1100044004ccc068dd59826182680080700698241baa304b004304b00330463754609200660920046eb0c108c10cc10cc10cc10c0254ccc0f4c0e00084c8c8c94ccc1014ccc100cdd79822801007099b8733301300100a00900514a020062c6eacc110c114004c100dd5182181098218100810299981ea99981e981b0020981b0018a50133700002905fcfd581880099980780b80180119980700b0028021bae303f3040002375c607c00260746ea8c0f4010dd7181e181e8011bae303b001303737546074004607460740026072004606e002606e606e606e60666ea80bc5858c0d4c0c8dd50179bad30343035303530353035303530353035303530353031375405a2c2a66605e60480082a66605e60466660040140109110369646f001302a33300230010100084890769646f706f7374001533302f30233030375405a2646464646464a66606a6050606c6ea80044c8c8c8c8c94ccc0e8c0bcc0ecdd5001099299981d9817181e1baa0011323232323232323232323232323232323232323232325333054305700213232323253330553375e038609e660b26ea40b92f5c02a6660aa609266605003c05c9110369646f00153330553371e03204a2a6660aa66e1c05408c4cdc38038110a5014a0294052819822802118218009822805982200718200078b1bac30550013055002375a60a600260a60046eb4c144004c144008dd698278009827801182680098268011bad304b001304b0023049001304900230470013047002375a608a002608a0046eb4c10c004c10c008dd71820800981e9baa00116303f303c37540042c607c60766ea8c0f8010c0f4c0f8008dd5981e000981e000981b9baa303a303737540022ca66606e02e298103d87a80001302c3303830390174bd701bad30383039002375a606e002606e606e0046eb8c0d4004c0c4dd50168b0a9998179812802099192999818981318191baa02f1325333032533303253330323330060020100171337100100022940528899b8900100913371066600a00601691010769646f706f7374004800058dd6981b181b98199baa02f1630353032375405e600202029408c8cc004004008894ccc0d000452f5bded8c0264646464a66606a66e452210000215333035302e00210031005133039337606ea4008dd3000998030030019bab3036003375c60680046070004606c00244464a666062604a60646ea8004520001375a606c60666ea8004c94ccc0c4c094c0c8dd50008a6103d87a8000132330010013756606e60686ea8008894ccc0d8004530103d87a80001323232325333037337220100042a66606e66e3c0200084c0bccc0ecdd4000a5eb80530103d87a8000133006006003375a60700066eb8c0d8008c0e8008c0e0004c8cc004004010894ccc0d40045300103d87a80001323232325333036337220100042a66606c66e3c0200084c0b8cc0e8dd3000a5eb80530103d87a80001330060060033756606e0066eb8c0d4008c0e4008c0dc0048894ccc0bcc088c0c0dd5001899191980080080211299981a8008a5013253330333371e6eb8c0e0008010528899801801800981c0009bae3034303137540062646600200200444a66606800229404c94ccc0c8cdd7981b981a1baa303730343754606e607060686ea8c0dc008018528899801801800981b80098161baa017375a605e60600046eb4c0b8004c8c8c94ccc0acc07cc0b0dd5000899192999816981098171baa0011330313750004660626064605e6ea80052f5c02c6062605c6ea800cdd6981818169baa00116302f302c3754605e004605c605e00260546ea801cdd7181618149baa00116302b3028375460560046eacc0a8c0ac004c098dd51814981518131baa3029302637540022c64646600200201444a666052002298103d87a80001323253330283375e605a60546ea80080144c080cc0b00092f5c0266008008002605a00460560026050604a6ea8028dd61813981400118130009813181318130011bab30240013024302400237586044002604460440046eb0c080004c070dd50010b180f180f801180e800980c9baa00114984d958c94ccc058c0240044c8c94ccc06cc0780084c9265333018300b30193754002264646464a66603e604400426493299980e1807980e9baa0031323253330213024002149858dd71811000980f1baa0031616375a60400026040004603c00260346ea80045858c070004c060dd50010a99980b18050008a99980c980c1baa00214985854ccc058c02c00454ccc064c060dd50010a4c2c2a66602c601a0022a66603260306ea80085261615333016300c00115333019301837540042930b0b180b1baa0013253330143007001132323232323232323232323232323232323232323232533302d3030002132323232498cc0780108c070004c07802cc074038c06403c58dd6181700098170011bad302c001302c002375a605400260540046eb4c0a0004c0a0008c098004c098008dd69812000981200118110009811001181000098100011bad301e001301e002375a603800260380046eb8c068004c058dd50090a99980a180400089919191919191919299980f981100109924c601600a2c6eb4c080004c080008dd6980f000980f001180e000980e0011bae301a001301637540242a6660286012002264646464a666036603c0042649318038018b1bad301c001301c002301a001301637540242c60286ea804494ccc04cc018c050dd5000899191919299980d180e80109924c600c0062c6eb4c06c004c06c008c064004c054dd50008b12999809180298099baa0011323232325333019301c00213232498c94ccc060c02c0044c8c94ccc074c0800084c92632533301b300e0011323253330203023002132498c03400458c084004c074dd50010a99980d98078008991919191919299981218138010a4c2c6eb4c094004c094008dd6981180098118011bad3021001301d37540042c60366ea800458c078004c068dd50018a99980c18060008a99980d980d1baa00314985858c060dd500118030018b180d000980d001180c000980a1baa0011623253330123005001132325333017301a002149858dd7180c000980a1baa002153330123006001132325333017301a002149858dd7180c000980a1baa002163012375400244646600200200644a66602c00229309919801801980d0011801980c00092999807980118081baa00113232323253330163019002149858dd7180b800980b8011bae3015001301137540022c602660206ea802cdc3a40006e1d2002370e90021b8748020dc3a400c6e952000371e91100374a90011b8848000dc02417f1b6e02ae6955ceaab9e5573eae815d0aba25748980129d8799fd8799f581cc51430536543185400801411f4c31d1ddf511f7f2aff55fba4b4824cffd87a80ff0001",
  );

  const txb = new TxBuilder(networkEnv).payTo(scriptUtxo.output);

  const canComplete = await txb.canComplete({
    changeAddress: changeAddress,
    coinSelectionAlgorithm: CoinSelectionAlgorithm.MINSWAP,
    walletUtxos: [feeUtxo],
    provider: new EmulatorProvider(networkEnv),
  });

  expect(canComplete).toBeTruthy();
});
