import type * as Ogmios from "@cardano-ogmios/schema";
import { RustModule } from "@repo/ledger-utils";
import * as fc from "fast-check";
import JSONBig from "json-bigint";
import { beforeAll, describe, expect, it } from "vitest";
import { ADA, Address, Bytes, DatumSourceType, PlutusVersion, type ScriptReference, TxIn, TxOut, Value } from "../src";
import { arbValue } from "./arb-things";

const arbTxIn: fc.Arbitrary<TxIn> = fc.record({
  txId: fc.uint8Array({ minLength: 32, maxLength: 32 }).map((b) => new Bytes(b)),
  index: fc.integer(),
});

beforeAll(async () => {
  await RustModule.load();
});

describe("example-based testing", () => {
  it("works", () => {
    const arbTxOut: fc.Arbitrary<TxOut> = fc
      .record({
        address: fc.constant(Address.fromBech32("addr_test1wr27yftrx5kg7809auy749e5tlsu9tev6ecq7hdtwhsgl4c6m6wxn")),
        value: arbValue,
        datumHash: fc.uint8Array({ minLength: 32, maxLength: 32 }).map((b) => new Bytes(b)),
      })
      .map(
        ({ address, value, datumHash }) =>
          new TxOut(address, value, { type: DatumSourceType.DATUM_HASH, hash: datumHash }),
      );
    fc.assert(
      fc.property(fc.array(arbTxOut), (txOuts) => {
        TxOut.sumValue(txOuts);
        return true;
      }),
    );
  });

  it("can round-trip TxIn PlutusData", () => {
    fc.assert(
      fc.property(arbTxIn, (pd) => {
        const roundTrip = TxIn.fromDataHex(TxIn.toDataHex(pd));
        expect(roundTrip).toEqual(pd);
      }),
    );
  });

  it("can do round-trip CSL conversion", () => {
    const arbTxOut: fc.Arbitrary<TxOut> = fc
      .record({
        address: fc.constant(Address.fromBech32("addr_test1wr27yftrx5kg7809auy749e5tlsu9tev6ecq7hdtwhsgl4c6m6wxn")),
        value: arbValue,
        datumHash: fc.uint8Array({ minLength: 32, maxLength: 32 }).map((b) => new Bytes(b)),
      })
      .map(
        ({ address, value, datumHash }) =>
          new TxOut(address, value, { type: DatumSourceType.DATUM_HASH, hash: datumHash }),
      );
    fc.assert(
      fc.property(arbTxOut, (txOut) => {
        return TxOut.fromHex(txOut.toCSL().to_hex()).value.equals(txOut.value);
      }),
    );
  });

  it("round-trip scriptRef", () => {
    const CSL = RustModule.get;
    const ogmiosScript =
      "590a3e0100003323232323232323232323232322323232323222232533300f323232323232323232323232323232323253330203370e900000089900099b873232300132323300101023232323232323232533302d3370e90010008991919b8f029001375c606a00260560042940c0ac004c0c8004c0a0004c0c0004c098004c0b8004c0b8004c08c004c0040048894ccc0a800852f5c026464a66604e600600426605a00466600a00a002006266600a00a002006605c0066058004600200244a66604e0022900009919b8048008cc00c00c004c0a800520021330213253330213370e900000089919191919191919191919192999819181a80109981718118059981718118049981719299981719b87480000044c8c94ccc0d4c0e00085261533032491334c6973742f5475706c652f436f6e73747220636f6e7461696e73206d6f7265206974656d73207468616e2065787065637465640016375c606c00260580102a66605c66e1d200200115333033302c008149854cc0c124011d4578706563746564206e6f206669656c647320666f7220436f6e737472001615330304912b436f6e73747220696e64657820646964206e6f74206d6174636820616e7920747970652076617269616e740016302c0073302e32533302e3370e90000008991919191919299981c981e0010a4c2a6606c921334c6973742f5475706c652f436f6e73747220636f6e7461696e73206d6f7265206974656d73207468616e2065787065637465640016375a607400260740046eb4c0e0004c0e0008dd6981b00098160030a99981719b87480080044c8c94ccc0d4c0e00085261533032491334c6973742f5475706c652f436f6e73747220636f6e7461696e73206d6f7265206974656d73207468616e2065787065637465640016375a606c002605800c2a66605c66e1d2004001132325333035303800213303133028001232498dd6800a4c2a66064921334c6973742f5475706c652f436f6e73747220636f6e7461696e73206d6f7265206974656d73207468616e20657870656374656400163758606c002605800c2a66605c66e1d2006001132325333035303800213303133028001232498dd6800a4c2a66064921334c6973742f5475706c652f436f6e73747220636f6e7461696e73206d6f7265206974656d73207468616e20657870656374656400163758606c002605800c2a66605c66e1d20080011323232325333037303a002149854cc0d12401334c6973742f5475706c652f436f6e73747220636f6e7461696e73206d6f7265206974656d73207468616e2065787065637465640016375a607000260700046eb4c0d8004c0b001854cc0c12412b436f6e73747220696e64657820646964206e6f74206d6174636820616e7920747970652076617269616e740016302c00549854cc0bd241334c6973742f5475706c652f436f6e73747220636f6e7461696e73206d6f7265206974656d73207468616e2065787065637465640016375a606600260660046eb4c0c4004c0c4008c0bc004c0bc008c0b4004c0b4008c0ac004c0ac008c0a4004c07c05854cc08d2412b436f6e73747220696e64657820646964206e6f74206d6174636820616e7920747970652076617269616e740016301f01532323232323232323300100b0033001001222533302e00214a026464a66605666e3c00800c528899980280280080198190019bae3030002375c60580026044a66604866e1d20003023001100115330264912a4578706563746564206f6e20696e636f727265637420636f6e7374727563746f722076617269616e742e0016302a00130200013028001301e015301e011301c533301e3370e9001180e80608060a998102492a4578706563746564206f6e20696e636f727265637420636f6e7374727563746f722076617269616e742e00163758604800260480026046002604400260420026040002603e002603c002603a0046eb0c06c004c04400cc064004c064008c05c004c034008526163300f32533300f3370e90000008a99980a18068018a4c2a6602292011d4578706563746564206e6f206669656c647320666f7220436f6e73747200161533300f3370e90010008a99980a18068018a4c2a6602292011d4578706563746564206e6f206669656c647320666f7220436f6e737472001615330114912b436f6e73747220696e64657820646964206e6f74206d6174636820616e7920747970652076617269616e740016300d002002232533300c3370e9000000899191919299980a980c00109980898038019980899299980899b87480000044c8c94ccc060c06c0084cc050c94ccc050cdc3a400000226464a666036603c00426602e601a002930a9980c2481334c6973742f5475706c652f436f6e73747220636f6e7461696e73206d6f7265206974656d73207468616e2065787065637465640016301c0013012002153330143370e90010008991919191919299980f98110010a4c2a660389201334c6973742f5475706c652f436f6e73747220636f6e7461696e73206d6f7265206974656d73207468616e2065787065637465640016375a604000260400046eb4c078004c078008dd6980e00098090010a9980b24812b436f6e73747220696e64657820646964206e6f74206d6174636820616e7920747970652076617269616e740016301200149854cc055241334c6973742f5475706c652f436f6e73747220636f6e7461696e73206d6f7265206974656d73207468616e20657870656374656400163019001300f002153330113370e90010008a99980b18078010a4c2a6602692011d4578706563746564206e6f206669656c647320666f7220436f6e737472001615330134912b436f6e73747220696e64657820646964206e6f74206d6174636820616e7920747970652076617269616e740016300f00149854cc049241334c6973742f5475706c652f436f6e73747220636f6e7461696e73206d6f7265206974656d73207468616e2065787065637465640016301600130160023014001300a002153300e4912b436f6e73747220696e64657820646964206e6f74206d6174636820616e7920747970652076617269616e740016300a001232533300b3370e9000000899192999809180a8010a4c2a6601e921334c6973742f5475706c652f436f6e73747220636f6e7461696e73206d6f7265206974656d73207468616e2065787065637465640016375c602600260120042a66601666e1d20020011323253330123015002149854cc03d2401334c6973742f5475706c652f436f6e73747220636f6e7461696e73206d6f7265206974656d73207468616e2065787065637465640016375c602600260120042a6601a9212b436f6e73747220696e64657820646964206e6f74206d6174636820616e7920747970652076617269616e74001630090013001001222533300f00214984cc02cc004c044008ccc00c00cc048008004dd700099800800a40004444666600e66e1c00400c0388cccc014014cdc00022400460200020040044600e6ea80048c014dd5000ab9a5736ae7155ceaab9e5573eae815d0aba24c11e581c18fd255917a50e470aadc70698700e4515cf4ffa95185f4f6c2816ec0001";
    const cborScript =
      "590a41590a3e0100003323232323232323232323232322323232323222232533300f323232323232323232323232323232323253330203370e900000089900099b873232300132323300101023232323232323232533302d3370e90010008991919b8f029001375c606a00260560042940c0ac004c0c8004c0a0004c0c0004c098004c0b8004c0b8004c08c004c0040048894ccc0a800852f5c026464a66604e600600426605a00466600a00a002006266600a00a002006605c0066058004600200244a66604e0022900009919b8048008cc00c00c004c0a800520021330213253330213370e900000089919191919191919191919192999819181a80109981718118059981718118049981719299981719b87480000044c8c94ccc0d4c0e00085261533032491334c6973742f5475706c652f436f6e73747220636f6e7461696e73206d6f7265206974656d73207468616e2065787065637465640016375c606c00260580102a66605c66e1d200200115333033302c008149854cc0c124011d4578706563746564206e6f206669656c647320666f7220436f6e737472001615330304912b436f6e73747220696e64657820646964206e6f74206d6174636820616e7920747970652076617269616e740016302c0073302e32533302e3370e90000008991919191919299981c981e0010a4c2a6606c921334c6973742f5475706c652f436f6e73747220636f6e7461696e73206d6f7265206974656d73207468616e2065787065637465640016375a607400260740046eb4c0e0004c0e0008dd6981b00098160030a99981719b87480080044c8c94ccc0d4c0e00085261533032491334c6973742f5475706c652f436f6e73747220636f6e7461696e73206d6f7265206974656d73207468616e2065787065637465640016375a606c002605800c2a66605c66e1d2004001132325333035303800213303133028001232498dd6800a4c2a66064921334c6973742f5475706c652f436f6e73747220636f6e7461696e73206d6f7265206974656d73207468616e20657870656374656400163758606c002605800c2a66605c66e1d2006001132325333035303800213303133028001232498dd6800a4c2a66064921334c6973742f5475706c652f436f6e73747220636f6e7461696e73206d6f7265206974656d73207468616e20657870656374656400163758606c002605800c2a66605c66e1d20080011323232325333037303a002149854cc0d12401334c6973742f5475706c652f436f6e73747220636f6e7461696e73206d6f7265206974656d73207468616e2065787065637465640016375a607000260700046eb4c0d8004c0b001854cc0c12412b436f6e73747220696e64657820646964206e6f74206d6174636820616e7920747970652076617269616e740016302c00549854cc0bd241334c6973742f5475706c652f436f6e73747220636f6e7461696e73206d6f7265206974656d73207468616e2065787065637465640016375a606600260660046eb4c0c4004c0c4008c0bc004c0bc008c0b4004c0b4008c0ac004c0ac008c0a4004c07c05854cc08d2412b436f6e73747220696e64657820646964206e6f74206d6174636820616e7920747970652076617269616e740016301f01532323232323232323300100b0033001001222533302e00214a026464a66605666e3c00800c528899980280280080198190019bae3030002375c60580026044a66604866e1d20003023001100115330264912a4578706563746564206f6e20696e636f727265637420636f6e7374727563746f722076617269616e742e0016302a00130200013028001301e015301e011301c533301e3370e9001180e80608060a998102492a4578706563746564206f6e20696e636f727265637420636f6e7374727563746f722076617269616e742e00163758604800260480026046002604400260420026040002603e002603c002603a0046eb0c06c004c04400cc064004c064008c05c004c034008526163300f32533300f3370e90000008a99980a18068018a4c2a6602292011d4578706563746564206e6f206669656c647320666f7220436f6e73747200161533300f3370e90010008a99980a18068018a4c2a6602292011d4578706563746564206e6f206669656c647320666f7220436f6e737472001615330114912b436f6e73747220696e64657820646964206e6f74206d6174636820616e7920747970652076617269616e740016300d002002232533300c3370e9000000899191919299980a980c00109980898038019980899299980899b87480000044c8c94ccc060c06c0084cc050c94ccc050cdc3a400000226464a666036603c00426602e601a002930a9980c2481334c6973742f5475706c652f436f6e73747220636f6e7461696e73206d6f7265206974656d73207468616e2065787065637465640016301c0013012002153330143370e90010008991919191919299980f98110010a4c2a660389201334c6973742f5475706c652f436f6e73747220636f6e7461696e73206d6f7265206974656d73207468616e2065787065637465640016375a604000260400046eb4c078004c078008dd6980e00098090010a9980b24812b436f6e73747220696e64657820646964206e6f74206d6174636820616e7920747970652076617269616e740016301200149854cc055241334c6973742f5475706c652f436f6e73747220636f6e7461696e73206d6f7265206974656d73207468616e20657870656374656400163019001300f002153330113370e90010008a99980b18078010a4c2a6602692011d4578706563746564206e6f206669656c647320666f7220436f6e737472001615330134912b436f6e73747220696e64657820646964206e6f74206d6174636820616e7920747970652076617269616e740016300f00149854cc049241334c6973742f5475706c652f436f6e73747220636f6e7461696e73206d6f7265206974656d73207468616e2065787065637465640016301600130160023014001300a002153300e4912b436f6e73747220696e64657820646964206e6f74206d6174636820616e7920747970652076617269616e740016300a001232533300b3370e9000000899192999809180a8010a4c2a6601e921334c6973742f5475706c652f436f6e73747220636f6e7461696e73206d6f7265206974656d73207468616e2065787065637465640016375c602600260120042a66601666e1d20020011323253330123015002149854cc03d2401334c6973742f5475706c652f436f6e73747220636f6e7461696e73206d6f7265206974656d73207468616e2065787065637465640016375c602600260120042a6601a9212b436f6e73747220696e64657820646964206e6f74206d6174636820616e7920747970652076617269616e74001630090013001001222533300f00214984cc02cc004c044008ccc00c00cc048008004dd700099800800a40004444666600e66e1c00400c0388cccc014014cdc00022400460200020040044600e6ea80048c014dd5000ab9a5736ae7155ceaab9e5573eae815d0aba24c11e581c18fd255917a50e470aadc70698700e4515cf4ffa95185f4f6c2816ec0001";

    // Ogmios script doesn't include CBOR encoding, we need to use a CSL.PlutusScript.to_hex() for adding CBOR encoding
    const originalPlutusScript = CSL.PlutusScript.new_v2(Bytes.fromHex(ogmiosScript).bytes);
    const scriptRefBytes = Bytes.fromHex(originalPlutusScript.to_hex());
    expect(scriptRefBytes.hex).toEqual(cborScript);

    const plutusScript = CSL.PlutusScript.from_bytes_v2(scriptRefBytes.bytes);
    const scriptRef = CSL.ScriptRef.new_plutus_script(plutusScript);
    const scriptRefHex = scriptRef.to_hex();
    const roundTrip = CSL.ScriptRef.from_hex(scriptRefHex);
    const roundTripHex = roundTrip.to_hex();
    expect(scriptRefHex).toEqual(roundTripHex);
  });

  it("round-trip TxOut ", () => {
    const output = TxOut.fromHex(
      "a3005839010000000000000000000000000000000000000000000000000000000052563c5410bff6a0d43ccebb7c37e1f69f5eb260552521adff33b9c2011a00cdb6d003d818590b4f8202590b4a590b47010000323232323232323232323232323232323232323232323232323232323232323232323232323232323232323232323232323232323232323232323222232323232323232323232533553333553335734608a00220222a666ae68c1100044c048dd69aba13046002153335734608600220282a666ae68c108004404c10054cd5400c54cd4c0f0488ccc070894cd4cc074c07c00802c4cc0100080044004004cc0ac094d5402010c0c08809c0948c854cd5401454cd5401854ccd5cd19b873535301e00f203e2233301333301c75c0246a604e6a01806240800040026a6a603c01e407c44666026666038eb8048d5400c810000800454cd54cd4cc128894cd40044c008c0cc1048854cd40044008884c018c0dc014c0dccccc070888c008d400c88cccd400880108010801094cd4ccccccd5d2001119192999ab9a3050001133335573e60a20044606603a40640722a666ae68c13c0044cccd55cf9828801101911999aab9f3574460a4006464a66a6666666ae9000480d480d480d48c0d8dd6801101a81e10981b18108008199aba13053004203303a039153335734609c00226666aae7cc1440088c0cc08080c80e454ccd5cd182680089999aab9f30510022303301f203203903030510013754006405e405e405e405e06c42a6666a0022c426609200200c2c2c2008400266603405840026aa01044444444408c07e064440682a66a66036012603aa00226602e603c01ea666a60306aa002406e2c42603e00242a66a66034002a0124260400022c04e04e04e04e04e266a6609244244a666ae68cdc4000a40002602a9210350543600153350021301549103505437002215333573460920062004266a600c06a00266e0400d200202f3302a024355007042001153355003153355004133015301c00d533353016355335303c12233301c2253353301d301f00200b13300400200110010013302b0253550080431622153350011002221620351621301d00121533533018001500721301e0011602502515335500315335500415335303c12233301c2253353301d301f00200b13300400200110010013302b0253550080430302202702502511200116304600137540142666aa6052056603a0384666ae68cdc7a99a9a9a980d00591110021119a8010139013908008b00081d81228010999aa9814015180e00d980d2451c7fe3920105a0aebaaecc1b935cd5ebbd3cc8c28336449d27378825e100500113302475c6aa0024444444444440082604a6a00607060346a60386a00204c4444008a66a6666a60446a00204a403e403e403e4666aa604a04e6604244a66a00442006200203e46464a66aa666ae68cdc79a80101d1a80081d0999ab9a3370e6a0040526a00205207204404226046006042603e006603c6a00207066044464a666ae68c0f4c1080044c8c848cc00400c008d5d09aba230420023574260820020766ea8004d4c090d40080dc88888888888803084004594ccd5cd181c981f0008991909198008018011aba135744607c0046ae84c0f40040dcdd5000998053ae75a444660784466a0029000111a801112999ab9a3371e0040102660844466a0029000111a801112999ab9a3371e00401a20022600c0060022600c0060064a66ae700045848888010848888c00c014480884807c894cd4cc018d40088888010d400488880104c8d4d400c80a888d400c894ccd5cd19b8f00400213301000300101735001202901223232533357346062002264244460040086ae84c0cc00854ccd5cd1818000899091118008021bae3574260660042a666ae68c0bc00409c0b4c0cc004dd5000911981991299a8008091109a801112999ab9a3371e004010260300022600c006666006eb88004d40048888888880a0888cc0cc88cccd55cf8009015919198171980b9803981b0009803181a80098021aba2003357420040366eac00488d400888d400c88c8cd40148cd401094ccd5cd19b8f00200100301520162335004201625333573466e3c00800400c05454cd400c854cd400884cd40088cd40088cd40088cd40088cc04400800480648cd400880648cc044008004888064888cd401080648894ccd5cd19b8700600315333573466e1c0140084ccd5cd19b8700400103201b01a01a01315335001201301d223030225335001100322133006002300400123007350012222004232533357346050605a002264646464646424666600200e00a006004660286601066010eb9d73ad357426ae88008dd69aba10013574400466600aeb9d71aba100135744605a004600e6ae84c0b0004098dd5000911192999ab9a3029302e00113300f300435742605a00260066ae84d5d118168008139baa00122333573466e3c00800408402848cc004894cd400805040040208cc02488ccd400c084008004d40040388c94ccd5cd1811981400089919191909198008028012999ab9a302600113232300d53335734605200226464646424466600200c0080066eb4d5d09aba2002375a6ae84004d5d118168019bad3574260580042a666ae68c0a00044c8488c00800cc020d5d0981600101318160009baa3574260540042a666ae68c09c004024090c0a8004dd51aba135744605000460066ae84c09c004084dd5000919192999ab9a30240011321223001003375c6ae84c09c00854ccd5cd181180089909118010019bae35742604e004042604e0026ea80048c94ccd5cd1810981300089919191919190919998008038028018011aba1357440046ae84004d5d10011aba100135744604c0046ae84c09400407cdd50009192999ab9a3020302500113232321233001003002375a6ae84d5d11813001a999ab9a302130260011375c6ae84c09400407cdd51aba1302400101e37540022002200e424460040064424660020060044466042446666aae7c00480648cc06cc014d5d080118019aba2002009375800246464a666ae68c0780044c848888c010014d5d0980f8010a999ab9a301d00113212222300200535742603e0042a666ae68c0700044c848888c004014d5d0980f8010a999ab9a301b00113212222300300535742603e004032603e0026ea80048c94ccd5cd180c980f0008991919191919191919191919191919191919191919190919999999999980080b80a8098088078068058048038028018011aba1357440046ae84004d5d10011aba1001357440046ae84004d5d10011aba1001357440046ae84004d5d10011aba1001357440046ae84004d5d10011aba1001357440046ae84004d5d10011aba100135744603c0046ae84c07400405cdd5000980e1108911299a80089a801803110999a80280c9802001199aa98038048028020009100089000980c91299a800801910a99a80088019109980b19980f911299a8010800910a99a8018802110a999a9980b80200109980e8021980380180289980e8011980380300089980e80219803801802802001180300088069a8028009110009a8018009110011a80080319801001091111998021299a8008980589119801007000910a99a8008980689119801002800910a999a99806002001099980300111980980280080089998038011807891198010030008008999803001119809802800800911299a800899808198080018011803007110a999a9980600280109980919809002802180400189998038011980900280200089980919809002802180400191119299a80109800804910a999a998068030010999803801118031980a003800800898018058999803801118031980a0038008009198089801980709119801003000980380124c4464642466600246006444600600846006444600400846006444600200846a60040066a006002600400444a666ae68cdc38010008018a999ab9a33712004002224440022244400422002444006466a00200800420024400444244660020080062a66ae7124103505431001622222222222200a370e90001b8748008dc3a40086e1d20065573caae748c8c00400488cc00cc0080080041",
    );
    const roundTrip = TxOut.fromHex(output.toHex());
    expect(roundTrip).toEqual(output);
  });

  it("round-trip TxOut with scriptRef", () => {
    const cborScript =
      "590a41590a3e0100003323232323232323232323232322323232323222232533300f323232323232323232323232323232323253330203370e900000089900099b873232300132323300101023232323232323232533302d3370e90010008991919b8f029001375c606a00260560042940c0ac004c0c8004c0a0004c0c0004c098004c0b8004c0b8004c08c004c0040048894ccc0a800852f5c026464a66604e600600426605a00466600a00a002006266600a00a002006605c0066058004600200244a66604e0022900009919b8048008cc00c00c004c0a800520021330213253330213370e900000089919191919191919191919192999819181a80109981718118059981718118049981719299981719b87480000044c8c94ccc0d4c0e00085261533032491334c6973742f5475706c652f436f6e73747220636f6e7461696e73206d6f7265206974656d73207468616e2065787065637465640016375c606c00260580102a66605c66e1d200200115333033302c008149854cc0c124011d4578706563746564206e6f206669656c647320666f7220436f6e737472001615330304912b436f6e73747220696e64657820646964206e6f74206d6174636820616e7920747970652076617269616e740016302c0073302e32533302e3370e90000008991919191919299981c981e0010a4c2a6606c921334c6973742f5475706c652f436f6e73747220636f6e7461696e73206d6f7265206974656d73207468616e2065787065637465640016375a607400260740046eb4c0e0004c0e0008dd6981b00098160030a99981719b87480080044c8c94ccc0d4c0e00085261533032491334c6973742f5475706c652f436f6e73747220636f6e7461696e73206d6f7265206974656d73207468616e2065787065637465640016375a606c002605800c2a66605c66e1d2004001132325333035303800213303133028001232498dd6800a4c2a66064921334c6973742f5475706c652f436f6e73747220636f6e7461696e73206d6f7265206974656d73207468616e20657870656374656400163758606c002605800c2a66605c66e1d2006001132325333035303800213303133028001232498dd6800a4c2a66064921334c6973742f5475706c652f436f6e73747220636f6e7461696e73206d6f7265206974656d73207468616e20657870656374656400163758606c002605800c2a66605c66e1d20080011323232325333037303a002149854cc0d12401334c6973742f5475706c652f436f6e73747220636f6e7461696e73206d6f7265206974656d73207468616e2065787065637465640016375a607000260700046eb4c0d8004c0b001854cc0c12412b436f6e73747220696e64657820646964206e6f74206d6174636820616e7920747970652076617269616e740016302c00549854cc0bd241334c6973742f5475706c652f436f6e73747220636f6e7461696e73206d6f7265206974656d73207468616e2065787065637465640016375a606600260660046eb4c0c4004c0c4008c0bc004c0bc008c0b4004c0b4008c0ac004c0ac008c0a4004c07c05854cc08d2412b436f6e73747220696e64657820646964206e6f74206d6174636820616e7920747970652076617269616e740016301f01532323232323232323300100b0033001001222533302e00214a026464a66605666e3c00800c528899980280280080198190019bae3030002375c60580026044a66604866e1d20003023001100115330264912a4578706563746564206f6e20696e636f727265637420636f6e7374727563746f722076617269616e742e0016302a00130200013028001301e015301e011301c533301e3370e9001180e80608060a998102492a4578706563746564206f6e20696e636f727265637420636f6e7374727563746f722076617269616e742e00163758604800260480026046002604400260420026040002603e002603c002603a0046eb0c06c004c04400cc064004c064008c05c004c034008526163300f32533300f3370e90000008a99980a18068018a4c2a6602292011d4578706563746564206e6f206669656c647320666f7220436f6e73747200161533300f3370e90010008a99980a18068018a4c2a6602292011d4578706563746564206e6f206669656c647320666f7220436f6e737472001615330114912b436f6e73747220696e64657820646964206e6f74206d6174636820616e7920747970652076617269616e740016300d002002232533300c3370e9000000899191919299980a980c00109980898038019980899299980899b87480000044c8c94ccc060c06c0084cc050c94ccc050cdc3a400000226464a666036603c00426602e601a002930a9980c2481334c6973742f5475706c652f436f6e73747220636f6e7461696e73206d6f7265206974656d73207468616e2065787065637465640016301c0013012002153330143370e90010008991919191919299980f98110010a4c2a660389201334c6973742f5475706c652f436f6e73747220636f6e7461696e73206d6f7265206974656d73207468616e2065787065637465640016375a604000260400046eb4c078004c078008dd6980e00098090010a9980b24812b436f6e73747220696e64657820646964206e6f74206d6174636820616e7920747970652076617269616e740016301200149854cc055241334c6973742f5475706c652f436f6e73747220636f6e7461696e73206d6f7265206974656d73207468616e20657870656374656400163019001300f002153330113370e90010008a99980b18078010a4c2a6602692011d4578706563746564206e6f206669656c647320666f7220436f6e737472001615330134912b436f6e73747220696e64657820646964206e6f74206d6174636820616e7920747970652076617269616e740016300f00149854cc049241334c6973742f5475706c652f436f6e73747220636f6e7461696e73206d6f7265206974656d73207468616e2065787065637465640016301600130160023014001300a002153300e4912b436f6e73747220696e64657820646964206e6f74206d6174636820616e7920747970652076617269616e740016300a001232533300b3370e9000000899192999809180a8010a4c2a6601e921334c6973742f5475706c652f436f6e73747220636f6e7461696e73206d6f7265206974656d73207468616e2065787065637465640016375c602600260120042a66601666e1d20020011323253330123015002149854cc03d2401334c6973742f5475706c652f436f6e73747220636f6e7461696e73206d6f7265206974656d73207468616e2065787065637465640016375c602600260120042a6601a9212b436f6e73747220696e64657820646964206e6f74206d6174636820616e7920747970652076617269616e74001630090013001001222533300f00214984cc02cc004c044008ccc00c00cc048008004dd700099800800a40004444666600e66e1c00400c0388cccc014014cdc00022400460200020040044600e6ea80048c014dd5000ab9a5736ae7155ceaab9e5573eae815d0aba24c11e581c18fd255917a50e470aadc70698700e4515cf4ffa95185f4f6c2816ec0001";
    const scriptRef: ScriptReference = { plutusVersion: PlutusVersion.V2, script: Bytes.fromHex(cborScript) };
    const output = new TxOut(
      Address.fromBech32(
        "addr_test1qqqk45c6mem5jzuev756udvtpgp4qgw4p6ec5lqnpmm9k00ea8klk3s04eylja2tyyn9z06tpkkdep463jgt2cnkflfssdj2vc",
      ),
      new Value().add(ADA, 3_189_400n),
      undefined,
      scriptRef,
    );
    const outputHex = output.toHex();
    const roundtrip = TxOut.fromHex(outputHex);
    expect(roundtrip.scriptRef).toEqual(output.scriptRef);
  });

  it("round-trip TxOut with Ogmios serialize/deserialize", () => {
    const ogmiosScript =
      "590a3e0100003323232323232323232323232322323232323222232533300f323232323232323232323232323232323253330203370e900000089900099b873232300132323300101023232323232323232533302d3370e90010008991919b8f029001375c606a00260560042940c0ac004c0c8004c0a0004c0c0004c098004c0b8004c0b8004c08c004c0040048894ccc0a800852f5c026464a66604e600600426605a00466600a00a002006266600a00a002006605c0066058004600200244a66604e0022900009919b8048008cc00c00c004c0a800520021330213253330213370e900000089919191919191919191919192999819181a80109981718118059981718118049981719299981719b87480000044c8c94ccc0d4c0e00085261533032491334c6973742f5475706c652f436f6e73747220636f6e7461696e73206d6f7265206974656d73207468616e2065787065637465640016375c606c00260580102a66605c66e1d200200115333033302c008149854cc0c124011d4578706563746564206e6f206669656c647320666f7220436f6e737472001615330304912b436f6e73747220696e64657820646964206e6f74206d6174636820616e7920747970652076617269616e740016302c0073302e32533302e3370e90000008991919191919299981c981e0010a4c2a6606c921334c6973742f5475706c652f436f6e73747220636f6e7461696e73206d6f7265206974656d73207468616e2065787065637465640016375a607400260740046eb4c0e0004c0e0008dd6981b00098160030a99981719b87480080044c8c94ccc0d4c0e00085261533032491334c6973742f5475706c652f436f6e73747220636f6e7461696e73206d6f7265206974656d73207468616e2065787065637465640016375a606c002605800c2a66605c66e1d2004001132325333035303800213303133028001232498dd6800a4c2a66064921334c6973742f5475706c652f436f6e73747220636f6e7461696e73206d6f7265206974656d73207468616e20657870656374656400163758606c002605800c2a66605c66e1d2006001132325333035303800213303133028001232498dd6800a4c2a66064921334c6973742f5475706c652f436f6e73747220636f6e7461696e73206d6f7265206974656d73207468616e20657870656374656400163758606c002605800c2a66605c66e1d20080011323232325333037303a002149854cc0d12401334c6973742f5475706c652f436f6e73747220636f6e7461696e73206d6f7265206974656d73207468616e2065787065637465640016375a607000260700046eb4c0d8004c0b001854cc0c12412b436f6e73747220696e64657820646964206e6f74206d6174636820616e7920747970652076617269616e740016302c00549854cc0bd241334c6973742f5475706c652f436f6e73747220636f6e7461696e73206d6f7265206974656d73207468616e2065787065637465640016375a606600260660046eb4c0c4004c0c4008c0bc004c0bc008c0b4004c0b4008c0ac004c0ac008c0a4004c07c05854cc08d2412b436f6e73747220696e64657820646964206e6f74206d6174636820616e7920747970652076617269616e740016301f01532323232323232323300100b0033001001222533302e00214a026464a66605666e3c00800c528899980280280080198190019bae3030002375c60580026044a66604866e1d20003023001100115330264912a4578706563746564206f6e20696e636f727265637420636f6e7374727563746f722076617269616e742e0016302a00130200013028001301e015301e011301c533301e3370e9001180e80608060a998102492a4578706563746564206f6e20696e636f727265637420636f6e7374727563746f722076617269616e742e00163758604800260480026046002604400260420026040002603e002603c002603a0046eb0c06c004c04400cc064004c064008c05c004c034008526163300f32533300f3370e90000008a99980a18068018a4c2a6602292011d4578706563746564206e6f206669656c647320666f7220436f6e73747200161533300f3370e90010008a99980a18068018a4c2a6602292011d4578706563746564206e6f206669656c647320666f7220436f6e737472001615330114912b436f6e73747220696e64657820646964206e6f74206d6174636820616e7920747970652076617269616e740016300d002002232533300c3370e9000000899191919299980a980c00109980898038019980899299980899b87480000044c8c94ccc060c06c0084cc050c94ccc050cdc3a400000226464a666036603c00426602e601a002930a9980c2481334c6973742f5475706c652f436f6e73747220636f6e7461696e73206d6f7265206974656d73207468616e2065787065637465640016301c0013012002153330143370e90010008991919191919299980f98110010a4c2a660389201334c6973742f5475706c652f436f6e73747220636f6e7461696e73206d6f7265206974656d73207468616e2065787065637465640016375a604000260400046eb4c078004c078008dd6980e00098090010a9980b24812b436f6e73747220696e64657820646964206e6f74206d6174636820616e7920747970652076617269616e740016301200149854cc055241334c6973742f5475706c652f436f6e73747220636f6e7461696e73206d6f7265206974656d73207468616e20657870656374656400163019001300f002153330113370e90010008a99980b18078010a4c2a6602692011d4578706563746564206e6f206669656c647320666f7220436f6e737472001615330134912b436f6e73747220696e64657820646964206e6f74206d6174636820616e7920747970652076617269616e740016300f00149854cc049241334c6973742f5475706c652f436f6e73747220636f6e7461696e73206d6f7265206974656d73207468616e2065787065637465640016301600130160023014001300a002153300e4912b436f6e73747220696e64657820646964206e6f74206d6174636820616e7920747970652076617269616e740016300a001232533300b3370e9000000899192999809180a8010a4c2a6601e921334c6973742f5475706c652f436f6e73747220636f6e7461696e73206d6f7265206974656d73207468616e2065787065637465640016375c602600260120042a66601666e1d20020011323253330123015002149854cc03d2401334c6973742f5475706c652f436f6e73747220636f6e7461696e73206d6f7265206974656d73207468616e2065787065637465640016375c602600260120042a6601a9212b436f6e73747220696e64657820646964206e6f74206d6174636820616e7920747970652076617269616e74001630090013001001222533300f00214984cc02cc004c044008ccc00c00cc048008004dd700099800800a40004444666600e66e1c00400c0388cccc014014cdc00022400460200020040044600e6ea80048c014dd5000ab9a5736ae7155ceaab9e5573eae815d0aba24c11e581c18fd255917a50e470aadc70698700e4515cf4ffa95185f4f6c2816ec0001";
    const ogmiosTxOut: Ogmios.TransactionOutput = {
      address:
        "addr_test1qqqk45c6mem5jzuev756udvtpgp4qgw4p6ec5lqnpmm9k00ea8klk3s04eylja2tyyn9z06tpkkdep463jgt2cnkflfssdj2vc",
      value: {
        ada: {
          lovelace: 10_000_000n,
        },
        e4214b7cce62ac6fbba385d164df48e157eae5863521b4b67ca71d86: {
          "3bb0079303c57812462dec9de8fb867cef8fd3768de7f12c77f6f0dd80381d0d": 1_000_000n,
        },
      },
      datum: undefined,
      datumHash: undefined,
      script: {
        language: "plutus:v2",
        cbor: ogmiosScript,
      },
    };
    const txOut = TxOut.fromOgmios(ogmiosTxOut);
    const roundTripOgmiosTxOut = txOut.toOgmios();
    expect(JSONBig.stringify(ogmiosTxOut)).toEqual(JSONBig.stringify(roundTripOgmiosTxOut));
  });
});
